<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="member">

	<select id="sequence" resultType="int">
		select member_seq.nextval from dual
	</select>

	<insert id="join" parameterType="MemberDto">
		insert into member(
			member_no,
			member_email, member_pw, member_nick,
			member_name, member_gender, member_birth,
			member_phone, member_mbti, member_animal, 
			member_interest1, member_interest2, member_interest3,
			member_place1, member_place2, member_place3
		)
		values(
			#{memberNo},
			#{memberEmail}, #{memberPw}, #{memberNick}, 
			#{memberName}, #{memberGender}, #{memberBirth}, 
			#{memberPhone}, #{memberMbti}, #{memberAnimal}, 
			#{memberInterest1}, #{memberInterest2}, #{memberInterest3}, 
			#{memberPlace1}, #{memberPlace2}, #{memberPlace3}
		)
	</insert>
	
	<select id="existEmail" parameterType="String" resultType="MemberDto">
		select * from member where member_email = #{memberEmail}
	</select>
	
	<!-- 단일조회 -->
	<select id="one" resultType="MemberDto" parameterType="int">
		select * from member where member_No = #{memberNo}
	</select>
	
	<!-- 로그인 시간 갱신 -->
	<update id="updateLastLogin" parameterType="String">
		update member 
		set member_logindate = sysdate 
		where member_email = #{memberEmail}
	</update>
	
	<!-- 이메일 찾기 -->
	<select id="findEmail" resultType="String" parameterType="MemberDto">
		select member_email from member 
		where 
			member_name = #{memberName}
			and
			member_Phone = #{memberPhone}
	</select>
	
	<!-- 비밀번호 찾기 -->
	<select id="find" resultType="MemberDto" parameterType="MemberDto">
		select * from member
		where
			member_name = #{memberName}
			and
			member_phone = #{memberPhone}
	</select>
	
	<!-- 비밀번호 변경 -->
	<update id="changePassword" parameterType="MemberDto">
		update member
		set member_pw = #{memberPw}
		where member_email = #{memberEmail}
	</update>
	
	<!-- 회원 탈퇴 -->
	<delete id="exit" parameterType="String">
		delete member where member_email = #{memberEmail}
	</delete>
	
	<!--  회원 전체 조회 -->
	 <select id="list" resultType="MemberDto">
 		select * from member order by member_no
 	</select>
 	
 	<!-- 정보 변경 -->
	<update id="changeInformation" parameterType="MemberDto">
		update member 
			set
				member_name = #{memberName}, member_email = #{memberEmail},
				member_pw = #{memberPw}, member_Nick = #{memberNick},
				member_gender = #{memberGender}, member_phone = #{memberPhone},
				member_sns_id = #{memberSnsId}, member_interest1 = #{memberInterest1},
				member_interest2 = #{memberInterest2}, member_interest3 = #{memberInterest3},
				member_place1 = #{memberPlace1}, member_place2 = #{memberPlace2}, member_place3 = #{memberPlace3}
			where
				member_email = #{memberEmail}
	</update>
	
	<!-- 소모임 생성 여부 확인용 -->
 	<select id="existClub" resultType="MemberDto" parameterType="int">
 		select * from member where member_no = #{memberNo}
 	</select>
 	<!-- 소모임 생성시 횟수 차감 -->
 	<update id="minusClubCount" parameterType="int">
 		update member set member_club_count = member_club_count - 1 where member_no  = #{memberNo}
 	</update>
 	
 	<!-- 회원 마이페이지 정보 -->
 	<resultMap type="MemberDetailVO" id="memberDetailVO">
 		
 		<association property="memberDto">
			<result column="member_no" property="memberNo"/>
			<result column="member_email" property="memberEmail"/>
			<result column="member_nick" property="memberNick"/>
			<result column="member_gender" property="memberGender"/>
			<result column="member_phone" property="memberPhone"/>
			<result column="member_birth" property="memberBirth"/>
			<result column="member_name" property="memberName"/>
			<result column="member_mbti" property="memberMbti"/>
			<result column="member_animal" property="memberAnimal"/>
			<result column="member_interest1" property="memberInterest1"/>
			<result column="member_interest2" property="memberInterest2"/>
			<result column="member_interest3" property="memberInterest3"/>
			<result column="member_place1" property="memberPlace1"/>
			<result column="member_place2" property="memberPlace2"/>
			<result column="member_place3" property="memberPlace3"/>
			<result column="member_admin" property="memberAdmin"/>
			<result column="member_report_count" property="memberReportCount"/>
			<result column="member_club_count" property="memberClubCount"/>
			<result column="member_sns_id" property="memberSnsId"/>
			<result column="member_logindate" property="memberLogindate"/>
		</association>
		
		<association property="memberProfileDto">
			<result column="member_no2" property="memberNo"/>
			<result column="attach_no2" property="attachNo"/>
		</association>
		
		<association property="clubDto">
			<result column="club_no" property="clubNo"/>
			<result column="club_leader" property="clubLeader"/>
			<result column="club_name" property="clubName"/>
			<result column="club_summary" property="clubSummary"/>
			<result column="club_main_category" property="clubMainCategory"/>
			<result column="club_sub_category" property="clubSubCategory"/>
			<result column="club_place" property="clubPlace"/>
			<result column="club_join_question1" property="clubJoinQuestion1"/>
			<result column="club_join_question2" property="clubJoinQuestion2"/>
			<result column="club_join_question3" property="clubJoinQuestion3"/>
			<result column="club_member_limit" property="clubMemberLimit"/>
			
			<result column="club_member_count" property="clubMemberCount"/>
		</association>
		
		<association property="clubLikeDto">
			<result column="club_like_no" property="clubLikeNo"/>
			<result column="club_no" property="clubNo"/>
			<result column="member_no" property="memberNo"/>
		</association>
		
		<association property="clubMemberDto">
			<result column="club_member_no" property="clubMemberNo"/>			
			<result column="club_no" property="clubNo"/>			
			<result column="member_no" property="memberNo"/>			
			<result column="club_member_date" property="clubMemberDate"/>			
			<result column="club_member_grade" property="clubMemberGrade"/>			
			<result column="club_member_answer1" property="clubMemberAnswer1"/>			
			<result column="club_member_answer2" property="clubMemberAnswer2"/>			
			<result column="club_member_answer3" property="clubMemberAnswer3"/>			
			<result column="club_member_permission" property="clubMemberPermission"/>			
			<result column="club_member_refuse_msg" property="clubMemberRefuseMsg"/>			
		</association>
		
 		
 	</resultMap>

	<select id="mypageMember" resultMap="memberDetailVO">
		SELECT 
			m.MEMBER_NO, 
			m.MEMBER_EMAIL, 
			m.MEMBER_NICK,
			m.MEMBER_GENDER,
			m.MEMBER_PHONE,
			m.MEMBER_BIRTH,
			m.MEMBER_NAME,
			m.MEMBER_MBTI,
			m.MEMBER_ANIMAL,
			m.MEMBER_INTEREST1,
			m.MEMBER_INTEREST2,
			m.MEMBER_INTEREST3,
			m.MEMBER_PLACE1,
			m.MEMBER_PLACE2,
			m.MEMBER_PLACE3,
			m.MEMBER_ADMIN,
			m.MEMBER_REPORT_COUNT,
			m.MEMBER_CLUB_COUNT,
			m.MEMBER_SNS_ID,
			m.MEMBER_LOGINDATE,
			mp.MEMBER_NO member_no2,
			mp.ATTACH_NO attach_no2
		FROM MEMBER m
		LEFT OUTER JOIN MEMBER_PROFILE mp 
			ON m.MEMBER_NO = mp.MEMBER_NO 
		WHERE m.member_no = #{memberNo}
	</select>
	<!-- 차단 시퀀스 -->
	<select id="blockedsequence" resultType="int">
		select blocked_seq.nextval from dual
	</select>
	<!-- 차단 -->
	<insert id="blocktarget" parameterType="blockedDto">
		insert into blocked (blocked_no, blocked_target, blocked_user)
		values (#{blockedNo}, #{blockedTarget}, #{blockedUser})
	</insert>
	
	<resultMap type="BlockedVO" id="blockedVOlist">
		<association property="memberDto">
			<result column="member_no" property="memberNo"/>
			<result column="member_email" property="memberEmail"/>
			<result column="member_pw" property="memberPw"/>
			<result column="member_nick" property="memberNick"/>
			<result column="member_gender" property="memberGender"/>
			<result column="member_mbti" property="memberMbti"/>
			<result column="member_animal" property="memberAnimal"/>
			<result column="member_interest1" property="memberInterest1"/>
			<result column="member_interest2" property="memberInterest2"/>
			<result column="member_interest3" property="memberInterest3"/>
			<result column="member_place1" property="memberPlace1"/>
			<result column="member_place2" property="memberPlace2"/>
			<result column="member_place3" property="memberPlace3"/>
			<result column="member_admin" property="memberAdmin"/>
			<result column="member_report_count" property="memberReportCount"/>
			<result column="member_club_count" property="memberClubCount"/>
			<result column="member_sns_id" property="memberSnsId"/>
			<result column="member_logindate" property="memberLogindate"/>
			<result column="member_birth" property="memberBirth"/>
			<result column="member_name" property="memberName"/>
		</association>
			<association property ="blockedDto">
			<result column="blocked_no" property="blockedNo"/>
			<result column="blocked_target" property="blockedTarget"/>
			<result column="blocked_user" property="blockedUser"/>
		</association>
	</resultMap>
	<!-- 조회 -->
	<select id="blockedlist" resultMap="blockedVOlist" parameterType="int">
		select 
		M.member_nick,
		B.*
		from 
		Member M
		left outer join blocked B
		on M.member_no = B.blocked_user
        where member_no = #{blockedUser}
		order by member_nick desc 
	</select>
	<!-- 단일조회 -->
	<select id="info" resultType="blockedDto" parameterType="int">
		select * from blocked where blocked_no= #{blockedNo}
	</select>
</mapper> 